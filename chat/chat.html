<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Fresca&family=Montserrat:ital,wght@0,400;0,500;1,400;1,500&display=swap" rel="stylesheet">
        <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
        <link rel="stylesheet" href="css/chat.css">
        <link rel="icon" href="assent/favicon.ico" type="image/x-icon">
        <title>Lobby</title>
    </head>
    <body>
        <header class="header">
            <img class="header-logo" src="assent/Untitled-fig (1).png" alt="Logo">
            <div class="header-config">
                <div class="header-config-user">
                    <img src="" alt="" class="userAvatar">
                    <p class="userNome"></p>
                    <div class="curtida com">
                        <ion-icon name="heart" class="curti"></ion-icon>
                        <p class="userCurtidas"></p>
                    </div>
                </div>
                <div class="header-config-exit" onclick="location.reload()">
                    <ion-icon name="log-out-outline"></ion-icon>
                </div>
                <div class="header-config-menu" id="menu">
                    <span class="line" id="l1"></span>
                    <span class="line" id="l2"></span>
                    <span class="line" id="l3"></span>
                </div>
            </div>
        </header>
        <main class="main">
            <div class="main-usuarios" id="usuarios">
                <div class="main-usuarios-config">
                    <div class="main-usuarios-config-user">
                        <img src="" alt="" class="userAvatar">
                        <p class="userNome"></p>
                        <div class="curtida com" id="coracao">
                            <ion-icon name="heart" class="curti"></ion-icon>
                            <p class="userCurtidas"></p>
                        </div>
                    </div>
                    <div class="main-usuarios-config-exit" onclick="location.reload()">
                        <ion-icon name="log-out-outline"></ion-icon>
                    </div>
                </div>
                <!--
                <div class="main-usuarios-user">
                    <img src="assent/avatar/avatar4.png" alt="">
                    <p>Alisson</p>
                    <div class="curtida sem">
                        <ion-icon name="heart-outline" class="nocurti"></ion-icon>
                        <ion-icon name="heart" class="curti"></ion-icon>
                        <p>0</p>
                    </div>
                </div>
                
                <div class="main-usuarios-user">
                    <img src="assent/avatar/avatar4.png" alt="">
                    <p>Alisson</p>
                    <div class="curtida sem">
                        <ion-icon name="heart-outline" class="nocurti"></ion-icon>
                        <ion-icon name="heart" class="curti"></ion-icon>
                        <p>0</p>
                    </div>
                </div>
                <div class="main-usuarios-user">
                    <img src="assent/avatar/avatar4.png" alt="">
                    <p>Alisson</p>
                    <div class="curtida sem">
                        <ion-icon name="heart-outline" class="nocurti"></ion-icon>
                        <ion-icon name="heart" class="curti"></ion-icon>
                        <p>0</p>
                    </div>
                </div>
                
                <div class="main-usuarios-user">
                    <img src="assent/avatar/avatar2.png" alt="">
                    <p>Alisson</p>
                    <div class="curtida sem">
                        <ion-icon name="heart-outline" class="nocurti"></ion-icon>
                        <ion-icon name="heart" class="curti"></ion-icon>
                        <p>0</p>
                    </div>
                </div>
                <div class="main-usuarios-user">
                    <img src="assent/avatar/avatar4.png" alt="">
                    <p>Alisson</p>
                    <div class="curtida sem">
                        <ion-icon name="heart-outline" class="nocurti"></ion-icon>
                        <ion-icon name="heart" class="curti"></ion-icon>
                        <p>0</p>
                    </div>
                </div>
                
                <div class="main-usuarios-user">
                    <img src="assent/avatar/avatar1.png" alt="">
                    <p>Alisson</p>
                    <div class="curtida sem">
                        <ion-icon name="heart-outline" class="nocurti"></ion-icon>
                        <ion-icon name="heart" class="curti"></ion-icon>
                        <p>0</p>
                    </div>
                </div>
                <div class="main-usuarios-user">
                    <img src="assent/avatar/avatar4.png" alt="">
                    <p>Alisson</p>
                    <div class="curtida sem">
                        <ion-icon name="heart-outline" class="nocurti"></ion-icon>
                        <ion-icon name="heart" class="curti"></ion-icon>
                        <p>0</p>
                    </div>
                </div>
                
                <div class="main-usuarios-user">
                    <img src="assent/avatar/avatar2.png" alt="">
                    <p>Alisson</p>
                    <div class="curtida sem">
                        <ion-icon name="heart-outline" class="nocurti"></ion-icon>
                        <ion-icon name="heart" class="curti"></ion-icon>
                        <p>0</p>
                    </div>
                </div>
                <div class="main-usuarios-user">
                    <img src="assent/avatar/avatar4.png" alt="">
                    <p>Alisson</p>
                    <div class="curtida sem">
                        <ion-icon name="heart-outline" class="nocurti"></ion-icon>
                        <ion-icon name="heart" class="curti"></ion-icon>
                        <p>0</p>
                    </div>
                </div>
                
                <div class="main-usuarios-user">
                    <img src="assent/avatar/avatar1.png" alt="">
                    <p>Alisson</p>
                    <div class="curtida sem">
                        <ion-icon name="heart-outline" class="nocurti"></ion-icon>
                        <ion-icon name="heart" class="curti"></ion-icon>
                        <p>0</p>
                    </div>
                </div>
                -->
            </div>
            <div class="main-conversa" id="conversa_cont">
                <div class="main-conversa-mensagens" id="conversa">
                <!--
                    <div class="main-conversa-mensagens-mensagem seu text">
                        <p class="nome">Alisson</p>
                        <p class="mensagem">Olá, tudo bem</p>
                    </div>
                    <div class="main-conversa-mensagens-mensagem seu text">
                        <p class="nome">Alisson</p>
                        <p class="mensagem">Premium designed icons for use in web, iOS, Android, and desktop apps. Support for SVG and web font. sempletely open source, MIT licensed and built by Ionic.</p>
                    </div>
                    <div class="main-conversa-mensagens-mensagem meu text">
                        <p class="nome">Alisson</p>
                        <p class="mensagem">Olá, tudo bem</p>
                    </div>
                    <div class="main-conversa-mensagens-mensagem seu text">
                        <p class="nome">Alisson</p>
                        <p class="mensagem">Olá, tudo bem</p>
                    </div>
                    <div class="main-conversa-mensagens-mensagem seu text">
                        <p class="nome">Alisson</p>
                        <p class="mensagem">Olá, tudo bem</p>
                    </div>
                    <div class="main-conversa-mensagens-mensagem seu text">
                        <p class="nome">Alisson</p>
                        <p class="mensagem">Premium designed icons for use in web, iOS, Android, and desktop apps. Support for SVG and web font. sempletely open source, MIT licensed and built by Ionic.</p>
                    </div>
                    <div class="main-conversa-mensagens-mensagem meu text">
                        <p class="nome">Alisson</p>
                        <p class="mensagem">Olá, tudo bem</p>
                    </div>
                    <div class="main-conversa-mensagens-mensagem seu text">
                        <p class="nome">Alisson</p>
                        <p class="mensagem">Olá, tudo bem</p>
                    </div>
                    <div class="main-conversa-mensagens-mensagem meu text">
                        <p class="nome">Alisson</p>
                        <p class="mensagem">Olá, tudo bem</p>
                    </div>
                    <div class="main-conversa-mensagens-mensagem seu text">
                        <p class="nome">Alisson</p>
                        <p class="mensagem">Premium designed icons for use in web, iOS, Android, and desktop apps. Support for SVG and web font. sempletely open source, MIT licensed and built by Ionic.</p>
                    </div>
                    <div class="main-conversa-mensagens-mensagem meu text">
                        <p class="nome">Alisson</p>
                        <p class="mensagem">Olá, tudo bem</p>
                    </div>
                    <div class="main-conversa-mensagens-mensagem meu text">
                        <p class="nome">Alisson</p>
                        <p class="mensagem">Olá, tudo bem</p>
                    </div>
                    <div class="main-conversa-mensagens-mensagem seu img">
                        <p class="nome">Alisson</p>
                        <img class="img" src="assent/Leonardo_Diffusion_soft_Chinese_ink_painting_soft_colors_rice_0.jpg" alt="">
                        <p class="mensagem">Premium designed icons for use in web, iOS, Android, and desktop apps. Support for SVG and web font. sempletely open source, MIT licensed and built by Ionic</p>
                    </div>
                    <div class="main-conversa-mensagens-mensagem seu text">
                        <p class="nome">Alisson</p>
                        <p class="mensagem">Premium designed icons for use in web, iOS, Android, and desktop apps. Support for SVG and web font. sempletely open source, MIT licensed and built by Ionic.</p>
                    </div>
                    <div class="main-conversa-mensagens-mensagem meu text">
                        <p class="nome">Alisson</p>
                        <p class="mensagem">Olá, tudo bem</p>
                    </div>
                    <div class="main-conversa-mensagens-mensagem seu text">
                        <p class="nome">Alisson</p>
                        <p class="mensagem">Olá, tudo bem</p>
                    </div>
                -->
                </div>
                <form class="main-conversa-input" id="form" action="">
                    <input style="display: none;" type="file" name="img" id="img">
                    <label class="imagem" for="img"><ion-icon name="image-outline"></ion-icon></label>
                    <input class="mens" id="inputText" type="text" placeholder="Mensagem ...">
                    <button class="enviar" id="bnt"><ion-icon name="paper-plane-outline"></ion-icon></button>
                </form>
            </div>
        </main>
    </body>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var menu = document.getElementById("menu");
        var usuarios = document.getElementById("usuarios");

        menu.addEventListener("click", () => {
            if(usuarios.classList[1] == "active") {
                usuarios.classList.remove("active");
                menu.classList.remove("active")
            } else {
                usuarios.classList.add("active");
                menu.classList.add("active")
            }
        })


        var conversaContent = document.getElementById("conversa_cont");
        var alturaBarraNavegacao = window.innerHeight - document.documentElement.clientHeight;

        conversaContent.style.height = 'calc(100vh - ' + alturaBarraNavegacao + 'px - 80px)';
    </script>
    <!-- <script>
    	function curtir() {
	        var curtida = document.querySelectorAll('.curtida');

	        for (var i = 0; i < curtida.length; i++) {
		        curtida[i].addEventListener("click", function() {
		            if (this.classList.contains("sem")) {
		                this.classList.remove("sem");
		                this.classList.add("com");
		            } else {
		                this.classList.remove("com");
		                this.classList.add("sem");
		            }
		        });
	        }
    	}
    </script> -->
    <script>
        var conversa = document.getElementById("conversa");

        function scroll() {
            conversa.scrollTop = conversa.scrollHeight;
        }

        window.addEventListener("load", function() {
            scroll()
        });
    </script>
    <script> // href="innerHTML.js"
        function mainUserDiv({nome, avatar, curtidas=0, id}) {
            /* const div = `
                <div class="main-usuarios-config">
                    <div class="main-usuarios-config-user">
                        <img src="${avatar}" alt="" class="userAvatar">
                        <p class="userNome">${nome}</p>
                        <div class="curtida com" id="coracao">
                            <ion-icon name="heart" class="curti"></ion-icon>
                            <p class="userCurtidas">${curtidas}</p>
                        </div>
                    </div>
                    <div class="main-usuarios-config-exit">
                        <ion-icon name="log-out-outline"></ion-icon>
                    </div>
                </div>
            `
            const usersList = document.querySelector('#usuarios')

            usersList.innerHTML += div  */

            const userNome = document.querySelectorAll(".userNome")
            const userAvatar = document.querySelectorAll(".userAvatar")
            const userCurtidas = document.querySelectorAll(".userCurtidas")

            for (const element of userNome) {
                element.textContent = nome
            }

            for (const element of userAvatar) {
                element.src = avatar
            }

            for (const element of userCurtidas) {
                element.textContent = curtidas
            }

            const usuario = {
                header: document.querySelector('.header-config-user > div'),
                main: document.querySelector('.main-usuarios-config-user > div')
            }

            for (const key in usuario) {
                usuario[key].id = `curtir${id}`
            }
        }

        function userDiv({nome, avatar, id, curtidas=0}) {
            const estado = curtidas == 0? 'sem' : 'com'
            const div = `
                <div class="main-usuarios-user" id="id${id}">
                    <img src="${avatar}" alt="">
                    <p>${nome}</p>
                    <div class="curtida ${estado}" onclick="curtir('${id}')">
                        <ion-icon name="heart-outline" class="nocurti"></ion-icon>
                        <ion-icon name="heart" class="curti"></ion-icon>
                        <p id="curtir${id}">${curtidas}</p>
                    </div>
                </div>`

            const usersList = document.querySelector('#usuarios')

            usersList.innerHTML += div  
        }

        function suaMSGtexto({nome, texto}) {
            const msg = `
                <div class="main-conversa-mensagens-mensagem seu text">
                    <p class="nome">${nome}</p>
                    <p class="mensagem">${texto}</p>
                </div>`

            conversa.innerHTML += msg
        }

        function minhaMSGtexto({nome, texto}) {
            const msg = `
                <div class="main-conversa-mensagens-mensagem meu text">
                    <p class="nome">${nome}</p>
                    <p class="mensagem">${texto}</p>
                </div>`

            conversa.innerHTML += msg
        }

        function suaMSGfoto({nome,texto, img}) {
            const msg = `
            <div class="main-conversa-mensagens-mensagem seu img">
                <p class="nome">${nome}</p>
                <img class="img" src="${img}" alt="">
                <p class="mensagem">${texto}</p>
            </div>`

            conversa.innerHTML += msg
        }

        function minhaMSGfoto({nome, texto, img}) {
            const msg = `
            <div class="main-conversa-mensagens-mensagem meu img">
                <p class="nome">${nome}</p>
                <img class="img" src="${img}" alt="">
                <p class="mensagem">${texto}</p>
            </div>`

            conversa.innerHTML += msg
        }
    </script>
    <script>
        const socket = io()


        socket.on('connect',() => {
            console.log(socket.id)
        })
        //id
        function id() {
        	//mudar pra hash
        	const regex = /[?&]id=([^&#]*)/i
	        const url = window.location.href
	        const match = regex.exec(url)
	        const id = match && match[1]
	        return id
	    }
        socket.emit('identificacao', id())

        socket.on('pessoas conectadas', (users) => {
            const usersList = document.querySelector('#usuarios')
            //usersList.innerHTML = ''

            for (let i in users) {
                if (users[i].socketID == socket.id) {
                    mainUserDiv(users[i])
                } else {
                    userDiv(users[i])
                }
            }
        })

        socket.on('adicionar usuario', usuario => {
            userDiv(usuario)
        })

        socket.on('remover usuario', usuario => {
            const div = document.querySelector(`#id${usuario}`)
            div.remove()
        })

        socket.on('curtir', usuario => {
            if (usuario.id == id()) {
                const curtidas = {
                    header: document.querySelector('.header-config-user > div'),
                    main: document.querySelector('.main-usuarios-config-user > div')
                }
                if (curtidas.header.classList.contains("sem")) {
                    for (const key in curtidas) {
                        curtidas[key].classList.remove("sem");
                        curtidas[key].classList.add("com");
                    }
                }
                const userCurtidas = document.querySelectorAll(".userCurtidas")

                for (const element of userCurtidas) {
                    element.textContent = usuario.curtidas
                }
            } else {
                const estado = document.querySelector(`#id${usuario.id} > div`)
                const curtir = document.querySelector(`#curtir${usuario.id}`)
                console.log(curtir, usuario.id, id())
                curtir.innerHTML =  usuario.curtidas
                console.log(estado)
                if (/* estado && */ estado.classList.contains("sem")) {
                    estado.classList.remove("sem")
                    estado.classList.add("com")
                }
            }
        })

        function curtir(id) {
            socket.emit('curtir', id)
        }

        socket.on('mensagem texto', (mensagem) => {
            if (mensagem.id == id()) {
                minhaMSGtexto(mensagem)
            } else {
                suaMSGtexto(mensagem)
            }
            scroll()
        })

        socket.on('mensagem img', (mensagem) => {
            if (mensagem.id == id()) {
                minhaMSGfoto(mensagem)
            } else {
                suaMSGfoto(mensagem)
            }
            scroll()
        })

        async function envMsg(id, imagem=false) {
            const mensagem = document.querySelector("#inputText").value

            if (!imagem) {
                if (mensagem.trim().length > 0) {
                    socket.emit('enviar mensagem', {
                        mensagem: mensagem,
                        id: id,
                        tipo: 'texto'
                    })
                }
            } else {
                socket.emit('enviar mensagem', {
                    mensagem: {
                        texto:mensagem,
                        img: imagem
                    },
                    id: id,
                    tipo: 'img'
                })
            }

        }


        const form = document.getElementById("form")

        form.addEventListener("submit", async (e) => {
            e.preventDefault()

            const input = document.querySelector("#img")

            const file = input.files[0];

            if (file) {
                try {
                    const img = await imageToBase64(file);
                    envMsg(id(), img)
                } catch (error) {
                    console.error(error);
                }
            } else {
                try {
                    envMsg(id())
                } catch (error) {
                    console.error(error)
                }
            } 
            

            const mensagem = document.querySelector("#inputText")
            mensagem.value = ''
            input.value = ''
            iconImg.style = "opacity: 1";
            foto.style = "background-image: none";
        })

        function imageToBase64(imageFile) {
            return new Promise((resolve, reject) => {
                // Cria um URL temporário para a imagem
                const imageUrl = URL.createObjectURL(imageFile);

                // Requisição assíncrona para obter os dados em formato de array buffer
                fetch(imageUrl)
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => {
                    // Converte o array buffer em uma string base64
                    const base64String = btoa(
                        new Uint8Array(arrayBuffer)
                        .reduce((data, byte) => data + String.fromCharCode(byte), '')
                    );

                    URL.revokeObjectURL(imageUrl);

                    resolve({string:base64String, tipo: imageFile.type});
                })
                .catch(error => {
                    reject(error);
                });
            });
        }
    </script>
    <script>
        let foto = document.getElementById('btnImg');
        let file = document.getElementById('img');
        let iconImg = document.getElementById("iconimg");

        file.addEventListener('change', (event) => {
            
            if(file.files.length <= 0) {
                return;
            }

            let reader = new FileReader();

            reader.onload = () => {
                foto.style = "background-image: url(" + reader.result + "); background-size: cover; background-position: center;";
                iconImg.style = "opacity: 0";
            }

            reader.readAsDataURL(file.files[0]);
        })
    </script>
</html>